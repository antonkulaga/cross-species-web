import * as graphdb from "graphdb"
import {GraphRepository} from "../graph";
import * as jest from "jest"
//import "@types/jest"
import {Gene, Orthology} from "../../shared/models";
import {ExpressionsTable, OrthologyData} from "../../shared/tables";
import {string} from "prop-types";
import {tab} from "@testing-library/user-event/dist/tab";
import {plainToClass} from "class-transformer";
const host = "http://graphdb.agingkills.eu" //http://10.40.3.21:7200

const repo = new GraphRepository(host)

test("expressions loading for selected species", async () => {
    const orthologyString = `{"reference_genes":[{"ensembl_id":"ENSG00000188747","symbol":"NOXA1"},{"ensembl_id":"ENSG00000170835","symbol":"CEL"},{"ensembl_id":"ENSG00000136436","symbol":"CALCOCO2"},{"ensembl_id":"ENSG00000198663","symbol":"C6orf89"},{"ensembl_id":"ENSG00000006282","symbol":"SPATA20"},{"ensembl_id":"ENSG00000142002","symbol":"DPP9"}],"species":["Homo_sapiens","Homo_sapiens","Homo_sapiens","Loxodonta_africana","Gopherus_agassizii","Gorilla_gorilla","Pan_troglodytes","Pongo_pygmaeus","Equus_caballus","Pan_paniscus","Pan_paniscus","Tursiops_truncatus","Tursiops_truncatus","Tursiops_truncatus"],"orthology_types":["ens:ortholog_one2one","ens:ortholog_one2many"],"orthologies":[],"byId":{},"orthology_table":{},"all_genes":[{"ensembl_id":"ENSG00000188747","symbol":"NOXA1"},{"ensembl_id":"ENSG00000170835","symbol":"CEL"},{"ensembl_id":"ENSG00000136436","symbol":"CALCOCO2"},{"ensembl_id":"ENSG00000198663","symbol":"C6orf89"},{"ensembl_id":"ENSG00000006282","symbol":"SPATA20"},{"ensembl_id":"ENSG00000142002","symbol":"DPP9"}],"bySpecies":{"undefined":[{"ensembl_id":"ENSG00000188747","symbol":"NOXA1"},{"ensembl_id":"ENSG00000170835","symbol":"CEL"},{"ensembl_id":"ENSG00000136436","symbol":"CALCOCO2"},{"ensembl_id":"ENSG00000198663","symbol":"C6orf89"},{"ensembl_id":"ENSG00000006282","symbol":"SPATA20"},{"ensembl_id":"ENSG00000142002","symbol":"DPP9"}]}}`
    const body: OrthologyData = JSON.parse(orthologyString)
    const ensembl_ids: Array<string> =  plainToClass(Gene, body.reference_genes).map(g=>g.ensembl_short)
    const orthos = await repo.orthology(ensembl_ids, body.species, body.orthology_types)
    const orthologyData = new OrthologyData(body.reference_genes, body.species, body.orthology_types, orthos)
    const expressionsString = `{"runs":["SRR306839","SRR306842","SRR1521445","SRR6307196","SRR1984647","SRR306808","SRR1758921","SRR306791","SRR636900","SRR306835","SRR306836","SRR3195103","SRR3195113","SRR5080392"],"genes":[{"ensembl_id":"ENSG00000188747","symbol":"NOXA1"},{"ensembl_id":"ENSG00000170835","symbol":"CEL"},{"ensembl_id":"ENSG00000136436","symbol":"CALCOCO2"},{"ensembl_id":"ENSG00000198663","symbol":"C6orf89"},{"ensembl_id":"ENSG00000006282","symbol":"SPATA20"},{"ensembl_id":"ENSG00000142002","symbol":"DPP9"},{"ensembl_id":"ENSECAG00000008281","symbol":"SPATA20","species":"Equus_caballus"},{"ensembl_id":"ENSGAGG00000000280","symbol":"SPATA20","species":"Gopherus_agassizii"},{"ensembl_id":"ENSGGOG00000003379","symbol":"SPATA20","species":"Gorilla_gorilla"},{"ensembl_id":"ENSLAFG00000022872","symbol":"SPATA20","species":"Loxodonta_africana"},{"ensembl_id":"ENSPPAG00000031622","symbol":"SPATA20","species":"Pan_paniscus"},{"ensembl_id":"ENSPPAG00000031622","symbol":"SPATA20","species":"Pan_paniscus"},{"ensembl_id":"ENSPPYG00000008278","symbol":"SPATA20","species":"Pongo_pygmaeus"},{"ensembl_id":"ENSPTRG00000009404","symbol":"SPATA20","species":"Pan_troglodytes"},{"ensembl_id":"ENSTTRG00000000215","symbol":"SPATA20","species":"Tursiops_truncatus"},{"ensembl_id":"ENSTTRG00000000215","symbol":"SPATA20","species":"Tursiops_truncatus"},{"ensembl_id":"ENSTTRG00000000215","symbol":"SPATA20","species":"Tursiops_truncatus"},{"ensembl_id":"ENSECAG00000015498","symbol":"CALCOCO2","species":"Equus_caballus"},{"ensembl_id":"ENSGAGG00000002628","symbol":"CALCOCO2","species":"Gopherus_agassizii"},{"ensembl_id":"ENSGGOG00000005537","symbol":"CALCOCO2","species":"Gorilla_gorilla"},{"ensembl_id":"ENSLAFG00000016693","symbol":"CALCOCO2","species":"Loxodonta_africana"},{"ensembl_id":"ENSPPAG00000037813","symbol":"CALCOCO2","species":"Pan_paniscus"},{"ensembl_id":"ENSPPAG00000037813","symbol":"CALCOCO2","species":"Pan_paniscus"},{"ensembl_id":"ENSPPYG00000008907","symbol":"CALCOCO2","species":"Pongo_pygmaeus"},{"ensembl_id":"ENSPTRG00000009363","symbol":"CALCOCO2","species":"Pan_troglodytes"},{"ensembl_id":"ENSTTRG00000008488","symbol":"CALCOCO2","species":"Tursiops_truncatus"},{"ensembl_id":"ENSTTRG00000008488","symbol":"CALCOCO2","species":"Tursiops_truncatus"},{"ensembl_id":"ENSTTRG00000008488","symbol":"CALCOCO2","species":"Tursiops_truncatus"},{"ensembl_id":"ENSECAG00000024983","symbol":"DPP9","species":"Equus_caballus"},{"ensembl_id":"ENSGAGG00000000955","symbol":"DPP9","species":"Gopherus_agassizii"},{"ensembl_id":"ENSGGOG00000002848","symbol":"DPP9","species":"Gorilla_gorilla"},{"ensembl_id":"ENSLAFG00000009122","symbol":"DPP9","species":"Loxodonta_africana"},{"ensembl_id":"ENSPPAG00000043157","symbol":"DPP9","species":"Pan_paniscus"},{"ensembl_id":"ENSPPAG00000043157","symbol":"DPP9","species":"Pan_paniscus"},{"ensembl_id":"ENSPPYG00000009415","symbol":"DPP9","species":"Pongo_pygmaeus"},{"ensembl_id":"ENSPTRG00000010319","symbol":"DPP9","species":"Pan_troglodytes"},{"ensembl_id":"ENSTTRG00000001733","symbol":"DPP9","species":"Tursiops_truncatus"},{"ensembl_id":"ENSTTRG00000001733","symbol":"DPP9","species":"Tursiops_truncatus"},{"ensembl_id":"ENSTTRG00000001733","symbol":"DPP9","species":"Tursiops_truncatus"},{"ensembl_id":"ENSECAG00000013218","symbol":"CEL","species":"Equus_caballus"},{"ensembl_id":"ENSGAGG00000021325","symbol":"CEL","species":"Gopherus_agassizii"},{"ensembl_id":"ENSGGOG00000015855","symbol":"","species":"Gorilla_gorilla"},{"ensembl_id":"ENSLAFG00000003263","symbol":"CEL","species":"Loxodonta_africana"},{"ensembl_id":"ENSPPAG00000034136","symbol":"","species":"Pan_paniscus"},{"ensembl_id":"ENSPPAG00000034136","symbol":"","species":"Pan_paniscus"},{"ensembl_id":"ENSPPYG00000019875","symbol":"","species":"Pongo_pygmaeus"},{"ensembl_id":"ENSTTRG00000014433","symbol":"CEL","species":"Tursiops_truncatus"},{"ensembl_id":"ENSTTRG00000014433","symbol":"CEL","species":"Tursiops_truncatus"},{"ensembl_id":"ENSTTRG00000014433","symbol":"CEL","species":"Tursiops_truncatus"},{"ensembl_id":"ENSECAG00000018904","symbol":"NOXA1","species":"Equus_caballus"},{"ensembl_id":"ENSGAGG00000021525","symbol":"","species":"Gopherus_agassizii"},{"ensembl_id":"ENSGGOG00000041617","symbol":"","species":"Gorilla_gorilla"},{"ensembl_id":"ENSPPAG00000037345","symbol":"NOXA1","species":"Pan_paniscus"},{"ensembl_id":"ENSPPAG00000037345","symbol":"NOXA1","species":"Pan_paniscus"},{"ensembl_id":"ENSPPYG00000019829","symbol":"","species":"Pongo_pygmaeus"},{"ensembl_id":"ENSPTRG00000042665","symbol":"","species":"Pan_troglodytes"},{"ensembl_id":"ENSTTRG00000003852","symbol":"NOXA1","species":"Tursiops_truncatus"},{"ensembl_id":"ENSTTRG00000003852","symbol":"NOXA1","species":"Tursiops_truncatus"},{"ensembl_id":"ENSTTRG00000003852","symbol":"NOXA1","species":"Tursiops_truncatus"},{"ensembl_id":"ENSECAG00000024122","symbol":"C20H6orf89","species":"Equus_caballus"},{"ensembl_id":"ENSGAGG00000008886","symbol":"C6orf89","species":"Gopherus_agassizii"},{"ensembl_id":"ENSGGOG00000013941","symbol":"C6orf89","species":"Gorilla_gorilla"},{"ensembl_id":"ENSLAFG00000000208","symbol":"C6orf89","species":"Loxodonta_africana"},{"ensembl_id":"ENSPPAG00000042318","symbol":"C6orf89","species":"Pan_paniscus"},{"ensembl_id":"ENSPPAG00000042318","symbol":"C6orf89","species":"Pan_paniscus"},{"ensembl_id":"ENSPPYG00000016555","symbol":"C6orf89","species":"Pongo_pygmaeus"},{"ensembl_id":"ENSPTRG00000024272","symbol":"C6H6orf89","species":"Pan_troglodytes"},{"ensembl_id":"ENSTTRG00000002299","symbol":"C6orf89","species":"Tursiops_truncatus"},{"ensembl_id":"ENSTTRG00000002299","symbol":"C6orf89","species":"Tursiops_truncatus"},{"ensembl_id":"ENSTTRG00000002299","symbol":"C6orf89","species":"Tursiops_truncatus"}]}`
    const expBody = JSON.parse(expressionsString)
    const { runs, genes }: {runs: Array<string>, genes: Array<Gene | string>} = expBody;
    if(genes.length > 0){
        const ensembl_ids = (genes[0] instanceof string) ? genes as Array<string>:  genes.map(gene=> (gene as Gene).ensembl_id)
        //console.log("loading gene expressions for ", ensembl_ids)
        const expressions = await repo.expressions(runs, ensembl_ids);
        //console.log("SRR306839" , expressions.filter(exp=>exp.run === "SRR306839" && exp.gene === "ENSG00000198663"))
        //console.log("EXPRESSIONS ARE: ", expressions)
        const table = new ExpressionsTable(orthologyData, runs, expressions)
        const rows = table.makeRows()
        console.log("ROWS ARE, rows:", rows)
    }
    /*
    const organisms = new Array<string>(
        "Homo_sapiens","Gopherus_agassizii", "Pan_troglodytes",
        "Pan_paniscus", "Tursiops_truncatus", "Macaca_mulatta", "Heterocephalus_glaber")
    const orthologyData = new OrthologyData(reference_genes, organisms, orthologyTypes, orthos)
    const expressionsString = `{"runs":["SRR306839","SRR306844","SRR306847","SRR1986757","SRR1510173","SRR1758922","SRR306826","SRR8750397","SRR5080324","SRR6073415","SRR306398"],"genes":[{"ensembl_id":"ENSG00000188747","symbol":"NOXA1"},{"ensembl_id":"ENSG00000170835","symbol":"CEL"},{"ensembl_id":"ENSG00000136436","symbol":"CALCOCO2"},{"ensembl_id":"ENSG00000198663","symbol":"C6orf89"},{"ensembl_id":"ENSG00000006282","symbol":"SPATA20"},{"ensembl_id":"ENSG00000142002","symbol":"DPP9"},{"ensembl_id":"ENSGAGG00000000280","symbol":"SPATA20","species":"Gopherus_agassizii"},{"ensembl_id":"ENSHGLG00100006048","symbol":"SPATA20","species":"Heterocephalus_glaber"},{"ensembl_id":"ENSMMUG00000017252","symbol":"SPATA20","species":"Macaca_mulatta"},{"ensembl_id":"ENSPPAG00000031622","symbol":"SPATA20","species":"Pan_paniscus"},{"ensembl_id":"ENSPPAG00000031622","symbol":"SPATA20","species":"Pan_paniscus"},{"ensembl_id":"ENSPTRG00000009404","symbol":"SPATA20","species":"Pan_troglodytes"},{"ensembl_id":"ENSPTRG00000009404","symbol":"SPATA20","species":"Pan_troglodytes"},{"ensembl_id":"ENSTTRG00000000215","symbol":"SPATA20","species":"Tursiops_truncatus"},{"ensembl_id":"ENSGAGG00000002628","symbol":"CALCOCO2","species":"Gopherus_agassizii"},{"ensembl_id":"ENSHGLG00100012406","symbol":"CALCOCO2","species":"Heterocephalus_glaber"},{"ensembl_id":"ENSMMUG00000012178","symbol":"CALCOCO2","species":"Macaca_mulatta"},{"ensembl_id":"ENSPPAG00000037813","symbol":"CALCOCO2","species":"Pan_paniscus"},{"ensembl_id":"ENSPPAG00000037813","symbol":"CALCOCO2","species":"Pan_paniscus"},{"ensembl_id":"ENSPTRG00000009363","symbol":"CALCOCO2","species":"Pan_troglodytes"},{"ensembl_id":"ENSPTRG00000009363","symbol":"CALCOCO2","species":"Pan_troglodytes"},{"ensembl_id":"ENSTTRG00000008488","symbol":"CALCOCO2","species":"Tursiops_truncatus"},{"ensembl_id":"ENSGAGG00000000955","symbol":"DPP9","species":"Gopherus_agassizii"},{"ensembl_id":"ENSHGLG00100017608","symbol":"DPP9","species":"Heterocephalus_glaber"},{"ensembl_id":"ENSMMUG00000021716","symbol":"DPP9","species":"Macaca_mulatta"},{"ensembl_id":"ENSPPAG00000043157","symbol":"DPP9","species":"Pan_paniscus"},{"ensembl_id":"ENSPPAG00000043157","symbol":"DPP9","species":"Pan_paniscus"},{"ensembl_id":"ENSPTRG00000010319","symbol":"DPP9","species":"Pan_troglodytes"},{"ensembl_id":"ENSPTRG00000010319","symbol":"DPP9","species":"Pan_troglodytes"},{"ensembl_id":"ENSTTRG00000001733","symbol":"DPP9","species":"Tursiops_truncatus"},{"ensembl_id":"ENSGAGG00000021325","symbol":"CEL","species":"Gopherus_agassizii"},{"ensembl_id":"ENSHGLG00100008388","symbol":"CEL","species":"Heterocephalus_glaber"},{"ensembl_id":"ENSMMUG00000001272","symbol":"CEL","species":"Macaca_mulatta"},{"ensembl_id":"ENSPPAG00000034136","symbol":"","species":"Pan_paniscus"},{"ensembl_id":"ENSPPAG00000034136","symbol":"","species":"Pan_paniscus"},{"ensembl_id":"ENSTTRG00000014433","symbol":"CEL","species":"Tursiops_truncatus"},{"ensembl_id":"ENSGAGG00000021525","symbol":"","species":"Gopherus_agassizii"},{"ensembl_id":"ENSMMUG00000019602","symbol":"NOXA1","species":"Macaca_mulatta"},{"ensembl_id":"ENSPPAG00000037345","symbol":"NOXA1","species":"Pan_paniscus"},{"ensembl_id":"ENSPPAG00000037345","symbol":"NOXA1","species":"Pan_paniscus"},{"ensembl_id":"ENSPTRG00000042665","symbol":"","species":"Pan_troglodytes"},{"ensembl_id":"ENSPTRG00000042665","symbol":"","species":"Pan_troglodytes"},{"ensembl_id":"ENSTTRG00000003852","symbol":"NOXA1","species":"Tursiops_truncatus"},{"ensembl_id":"ENSGAGG00000008886","symbol":"C6orf89","species":"Gopherus_agassizii"},{"ensembl_id":"ENSHGLG00100013699","symbol":"C6orf89","species":"Heterocephalus_glaber"},{"ensembl_id":"ENSMMUG00000005004","symbol":"C4H6orf89","species":"Macaca_mulatta"},{"ensembl_id":"ENSPPAG00000042318","symbol":"C6orf89","species":"Pan_paniscus"},{"ensembl_id":"ENSPPAG00000042318","symbol":"C6orf89","species":"Pan_paniscus"},{"ensembl_id":"ENSPTRG00000024272","symbol":"C6H6orf89","species":"Pan_troglodytes"},{"ensembl_id":"ENSPTRG00000024272","symbol":"C6H6orf89","species":"Pan_troglodytes"},{"ensembl_id":"ENSTTRG00000002299","symbol":"C6orf89","species":"Tursiops_truncatus"}]}`
    const body = JSON.parse(expressionsString)
    const { runs, genes }: {runs: Array<string>, genes: Array<Gene | string>} = body;
    if(genes.length > 0){
        const ensembl_ids = (genes[0] instanceof string) ? genes as Array<string>:  genes.map(gene=> (gene as Gene).ensembl_id)
        console.log("loading gene expressions for ", ensembl_ids)
        const expressions = await repo.expressions(runs, ensembl_ids);
        console.log("EXPRESSIONS ARE: ", expressions)
        const table = new ExpressionsTable(orthologyData, runs, expressions)
        const rows = table.makeRows()
        console.log("ROWS ARE, rows:")
    }
    /*
    //repo.get
    const requestString= `{"runs":["SRR306841","SRR787277","SRR6307196","SRR306808","SRR636900","SRR3195096","SRR223512","ERR1331676"],
    "genes":[{"ensembl_id":"ENSG00000188747","symbol":"NOXA1"},{"ensembl_id":"ENSG00000170835","symbol":"CEL"},{"ensembl_id":"ENSG00000136436","symbol":"CALCOCO2"},{"ensembl_id":"ENSG00000198663","symbol":"C6orf89"},{"ensembl_id":"ENSG00000006282","symbol":"SPATA20"},{"ensembl_id":"ENSG00000142002","symbol":"DPP9"},{"ensembl_id":"ENSECAG00000008281","symbol":"SPATA20","species":"Equus_caballus"},{"ensembl_id":"ENSGGOG00000003379","symbol":"SPATA20","species":"Gorilla_gorilla"},{"ensembl_id":"ENSHGLG00100006048","symbol":"SPATA20","species":"Heterocephalus_glaber"},{"ensembl_id":"ENSLAFG00000022872","symbol":"SPATA20","species":"Loxodonta_africana"},{"ensembl_id":"ENSMFAG00000044525","symbol":"SPATA20","species":"Macaca_fascicularis"},{"ensembl_id":"ENSTTRG00000000215","symbol":"SPATA20","species":"Tursiops_truncatus"},{"ensembl_id":"ENSECAG00000015498","symbol":"CALCOCO2","species":"Equus_caballus"},{"ensembl_id":"ENSGGOG00000005537","symbol":"CALCOCO2","species":"Gorilla_gorilla"},{"ensembl_id":"ENSHGLG00100012406","symbol":"CALCOCO2","species":"Heterocephalus_glaber"},{"ensembl_id":"ENSLAFG00000016693","symbol":"CALCOCO2","species":"Loxodonta_africana"},{"ensembl_id":"ENSMFAG00000000840","symbol":"CALCOCO2","species":"Macaca_fascicularis"},{"ensembl_id":"ENSTTRG00000008488","symbol":"CALCOCO2","species":"Tursiops_truncatus"},{"ensembl_id":"ENSECAG00000024983","symbol":"DPP9","species":"Equus_caballus"},{"ensembl_id":"ENSGGOG00000002848","symbol":"DPP9","species":"Gorilla_gorilla"},{"ensembl_id":"ENSHGLG00100017608","symbol":"DPP9","species":"Heterocephalus_glaber"},{"ensembl_id":"ENSLAFG00000009122","symbol":"DPP9","species":"Loxodonta_africana"},{"ensembl_id":"ENSMFAG00000040299","symbol":"DPP9","species":"Macaca_fascicularis"},{"ensembl_id":"ENSTTRG00000001733","symbol":"DPP9","species":"Tursiops_truncatus"},{"ensembl_id":"ENSECAG00000013218","symbol":"CEL","species":"Equus_caballus"},{"ensembl_id":"ENSGGOG00000015855","symbol":"","species":"Gorilla_gorilla"},{"ensembl_id":"ENSHGLG00100008388","symbol":"CEL","species":"Heterocephalus_glaber"},{"ensembl_id":"ENSLAFG00000003263","symbol":"CEL","species":"Loxodonta_africana"},{"ensembl_id":"ENSMFAG00000042247","symbol":"CEL","species":"Macaca_fascicularis"},{"ensembl_id":"ENSTTRG00000014433","symbol":"CEL","species":"Tursiops_truncatus"},{"ensembl_id":"ENSECAG00000018904","symbol":"NOXA1","species":"Equus_caballus"},{"ensembl_id":"ENSGGOG00000041617","symbol":"","species":"Gorilla_gorilla"},{"ensembl_id":"ENSMFAG00000030739","symbol":"NOXA1","species":"Macaca_fascicularis"},{"ensembl_id":"ENSTTRG00000003852","symbol":"NOXA1","species":"Tursiops_truncatus"},{"ensembl_id":"ENSECAG00000024122","symbol":"C20H6orf89","species":"Equus_caballus"},{"ensembl_id":"ENSGGOG00000013941","symbol":"C6orf89","species":"Gorilla_gorilla"},{"ensembl_id":"ENSHGLG00100013699","symbol":"C6orf89","species":"Heterocephalus_glaber"},{"ensembl_id":"ENSLAFG00000000208","symbol":"C6orf89","species":"Loxodonta_africana"},{"ensembl_id":"ENSMFAG00000042966","symbol":"C6orf89","species":"Macaca_fascicularis"},{"ensembl_id":"ENSTTRG00000002299","symbol":"C6orf89","species":"Tursiops_truncatus"}]}`
    const body = JSON.parse(requestString)
    const { runs, genes }: {runs: Array<string>, genes: Array<Gene | string>} = body;
    if(genes.length > 0){
        const ensembl_ids = (genes[0] instanceof string) ? genes as Array<string>:  genes.map(gene=> (gene as Gene).ensembl_id)
        console.log("loading gene expressions for ", ensembl_ids)
        const expressions = await repo.expressions(runs, ensembl_ids);
        console.log("EXPRESSIONS ARE: ", expressions)
        new ExpressionsTable(orthologyData,runs, expressions)
    }
     */
})